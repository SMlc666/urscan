name: C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        mode: [debug, release]
        arch: [x86_64, aarch64]
        multithread: [true, false]
        prefetch: [true, false]
        neon: [true, false]
        exclude:
          # NEON is only for ARM
          - arch: x86_64
            neon: true

    runs-on: ${{ matrix.arch == 'aarch64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install LLVM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm

    - name: Install Xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Configure build
      run: |
        DEFINES=""
        if [[ "${{ matrix.multithread }}" == "true" ]]; then
          DEFINES="$DEFINES -DUR_ENABLE_MULTITHREADING"
        fi
        if [[ "${{ matrix.prefetch }}" == "true" ]]; then
          DEFINES="$DEFINES -DUR_ENABLE_HARDWARE_PREFETCH"
        fi
        if [[ "${{ matrix.arch }}" == "aarch64" && "${{ matrix.neon }}" == "true" ]]; then
          DEFINES="$DEFINES -DUR_ENABLE_NEON_OPTIMIZATION"
        fi
        
        # Trim leading space if it exists
        DEFINES=$(echo "$DEFINES" | sed 's/^ *//')

        echo "Configuring with cxxflags: $DEFINES"
        xmake f --toolchain=llvm --mode=${{ matrix.mode }} --arch=${{ matrix.arch }} --cxxflags="$DEFINES" -y

    - name: Build all targets
      run: xmake build -vD -y

    - name: Run tests
      run: xmake run tests -y

    - name: Run benchmark
      run: xmake run benchmark -y
